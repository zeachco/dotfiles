#!/bin/bash

# Theme switcher for dotfiles
# Copies selected theme to themes/current for configs to reference

set -e

DOTFILES_PATH="${DOTFILES_PATH:-$HOME/dotfiles}"
THEMES_PATH="$DOTFILES_PATH/themes"
CURRENT_THEME_PATH="$THEMES_PATH/current"

# Select theme
if [ -n "$1" ]; then
  THEME="$1"
  # say "theme $THEME"
  if [ ! -d "$THEMES_PATH/$THEME" ]; then
    echo "Error: Theme '$THEME' not found"
    echo "Available themes:"
    for theme_dir in "$THEMES_PATH"/*/; do
      [ -d "$theme_dir" ] && [ "$(basename "$theme_dir")" != "current" ] && echo "  - $(basename "$theme_dir")"
    done
    exit 1
  fi
else
  if command -v fzf &>/dev/null; then
    THEME=$(find "$THEMES_PATH" -mindepth 1 -maxdepth 1 -type d ! -name "current" -exec basename {} \; | fzf --prompt="Choose your theme: " --height=~50% --border)
  else
    echo "Error: fzf is required for theme selection"
    echo "Install it with: brew install fzf (macOS) or apt install fzf (Linux)"
    exit 1
  fi
fi

[ -z "$THEME" ] && echo "No theme selected" && exit 1

echo "Switching to theme: $THEME"

# Copy theme to current
[ -d "$CURRENT_THEME_PATH" ] && rm -rf "$CURRENT_THEME_PATH"
cp -r "$THEMES_PATH/$THEME" "$CURRENT_THEME_PATH"

# Update nvim references (unless skipped)
if [ "$SKIP_NVIM" != "true" ]; then
  # Copy custom neovim colorscheme if exists
  if [ -f "$CURRENT_THEME_PATH/colors.lua" ]; then
    mkdir -p "$HOME/.config/nvim/colors"
    cp -f "$CURRENT_THEME_PATH/colors.lua" "$HOME/.config/nvim/colors/${THEME}.lua"
  fi
fi

# Update zellij
if command -v zellij &>/dev/null && [ -f "$CURRENT_THEME_PATH/zellij.kdl" ]; then
  mkdir -p "$HOME/.config/zellij/themes"
  sed 's/themes {$/themes {\n  current {/; /^  [a-z-]* {$/d' "$CURRENT_THEME_PATH/zellij.kdl" >"$HOME/.config/zellij/themes/current.kdl"

  # Reload config for all running sessions
  sessions=$(zellij list-sessions 2>/dev/null | grep -v "EXITED" | awk '{print $1}' || true)
  if [ -n "$sessions" ]; then
    for session in $sessions; do
      zellij action --session "$session" reload-config 2>/dev/null || true
    done
  fi
fi

# Update btop
if command -v btop &>/dev/null && [ -f "$CURRENT_THEME_PATH/btop.theme" ]; then
  mkdir -p "$HOME/.config/btop/themes"
  cp -f "$CURRENT_THEME_PATH/btop.theme" "$HOME/.config/btop/themes/current.theme" 2>/dev/null || true
fi

# Update Claude
if [ -f "$HOME/.claude/settings.json" ] && [ -f "$CURRENT_THEME_PATH/claude-theme" ]; then
  CLAUDE_THEME=$(cat "$CURRENT_THEME_PATH/claude-theme" | tr -d '[:space:]')
  if command -v jq &>/dev/null; then
    jq --arg theme "$CLAUDE_THEME" '. + {theme: $theme}' "$HOME/.claude/settings.json" >"$HOME/.claude/settings.json.tmp"
    mv "$HOME/.claude/settings.json.tmp" "$HOME/.claude/settings.json"
  else
    if grep -q '"theme"' "$HOME/.claude/settings.json"; then
      sed -i.bak "s/\"theme\": \".*\"/\"theme\": \"$CLAUDE_THEME\"/g" "$HOME/.claude/settings.json"
    else
      sed -i.bak "s/}$/,\n  \"theme\": \"$CLAUDE_THEME\"\n}/g" "$HOME/.claude/settings.json"
    fi
    rm -f "$HOME/.claude/settings.json.bak"
  fi
fi

# Run vscode theme script if exists
[ -f "$CURRENT_THEME_PATH/vscode.sh" ] && source "$CURRENT_THEME_PATH/vscode.sh"

echo "âœ“ Theme '$THEME' applied successfully!"
