#!/bin/bash

# Theme switcher for dotfiles
# Copies selected theme to themes/current for configs to reference

set -e

DOTFILES_PATH="${DOTFILES_PATH:-$HOME/dotfiles}"
THEMES_PATH="$DOTFILES_PATH/themes"
CURRENT_THEME_PATH="$THEMES_PATH/current"
SKIP_NVIM="${SKIP_NVIM:-false}"

# Discover available themes
THEME_NAMES=()
for theme_dir in "$THEMES_PATH"/*/ ; do
  if [ -d "$theme_dir" ]; then
    theme_basename=$(basename "$theme_dir")
    [ "$theme_basename" = "current" ] && continue
    theme_name=$(echo "$theme_basename" | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2));}1')
    THEME_NAMES+=("$theme_name")
  fi
done

[ ${#THEME_NAMES[@]} -eq 0 ] && echo "No themes found in $THEMES_PATH" && exit 1

# Select theme
if [ -n "$1" ]; then
  THEME="$1"
  if [ ! -d "$THEMES_PATH/$THEME" ]; then
    echo "Error: Theme '$THEME' not found"
    echo "Available themes:"
    for theme_dir in "$THEMES_PATH"/*/ ; do
      [ -d "$theme_dir" ] && [ "$(basename "$theme_dir")" != "current" ] && echo "  - $(basename "$theme_dir")"
    done
    exit 1
  fi
else
  if command -v gum &>/dev/null; then
    THEME=$(gum choose "${THEME_NAMES[@]}" --header "Choose your theme" --height 8 | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
  else
    echo "Available themes:"
    select theme_name in "${THEME_NAMES[@]}"; do
      [ -n "$theme_name" ] && THEME=$(echo "$theme_name" | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g') && break
    done
  fi
fi

[ -z "$THEME" ] && echo "No theme selected" && exit 1

echo "Switching to theme: $THEME"

# Copy theme to current
[ -d "$CURRENT_THEME_PATH" ] && rm -rf "$CURRENT_THEME_PATH"
cp -r "$THEMES_PATH/$THEME" "$CURRENT_THEME_PATH"

# Update nvim references (unless skipped)
if [ "$SKIP_NVIM" != "true" ] && [ -f "$CURRENT_THEME_PATH/neovim.lua" ]; then
  COLORSCHEME=$(grep -o 'colorscheme = "[^"]*"' "$CURRENT_THEME_PATH/neovim.lua" | sed 's/colorscheme = "\([^"]*\)"/\1/')
  if [ -n "$COLORSCHEME" ]; then
    mkdir -p "$HOME/.config/nvim"
    echo "$COLORSCHEME" > "$HOME/.config/nvim/theme-dark"
    echo "$COLORSCHEME" > "$HOME/.config/nvim/theme-light"
  fi
fi

# Update zellij
if command -v zellij &>/dev/null && [ -f "$CURRENT_THEME_PATH/zellij.kdl" ]; then
  mkdir -p "$HOME/.config/zellij/themes"
  sed 's/themes {$/themes {\n  current {/; /^  [a-z-]* {$/d' "$CURRENT_THEME_PATH/zellij.kdl" > "$HOME/.config/zellij/themes/current.kdl"
  [ -n "$ZELLIJ" ] && zellij action switch-mode normal 2>/dev/null && zellij action switch-theme "current" 2>/dev/null || true
fi

# Update btop
if command -v btop &>/dev/null && [ -f "$CURRENT_THEME_PATH/btop.theme" ]; then
  mkdir -p "$HOME/.config/btop/themes"
  cp -f "$CURRENT_THEME_PATH/btop.theme" "$HOME/.config/btop/themes/current.theme" 2>/dev/null || true
fi

# Update Claude
if [ -f "$HOME/.claude/settings.json" ] && [ -f "$CURRENT_THEME_PATH/claude-theme" ]; then
  CLAUDE_THEME=$(cat "$CURRENT_THEME_PATH/claude-theme" | tr -d '[:space:]')
  if command -v jq &>/dev/null; then
    jq --arg theme "$CLAUDE_THEME" '. + {theme: $theme}' "$HOME/.claude/settings.json" > "$HOME/.claude/settings.json.tmp"
    mv "$HOME/.claude/settings.json.tmp" "$HOME/.claude/settings.json"
  else
    if grep -q '"theme"' "$HOME/.claude/settings.json"; then
      sed -i.bak "s/\"theme\": \".*\"/\"theme\": \"$CLAUDE_THEME\"/g" "$HOME/.claude/settings.json"
    else
      sed -i.bak "s/}$/,\n  \"theme\": \"$CLAUDE_THEME\"\n}/g" "$HOME/.claude/settings.json"
    fi
    rm -f "$HOME/.claude/settings.json.bak"
  fi
fi

# Run vscode theme script if exists
[ -f "$CURRENT_THEME_PATH/vscode.sh" ] && source "$CURRENT_THEME_PATH/vscode.sh"

echo "âœ“ Theme '$THEME' applied successfully!"
